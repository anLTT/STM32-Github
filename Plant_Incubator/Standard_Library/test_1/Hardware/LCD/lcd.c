/****************************************************************************************************
//=========================================???????================================================//
//     LCD???                STM32?????
//      VCC          ??          3.3V         //???
//      GND          ??          GND          //?????
//=======================================??????????????==========================================//
//?????????????????????SPI????
//     LCD???                STM32?????    
//    SDI(MOSI)      ??          PA7         //?????SPI????????ï¿½ï¿½??? 
//       LED         ??          PB6         //???????????????
//       SCK         ??          PA5         //?????SPI??????????
//      DC/RS        ??          PB7         //?????????/???????????NC??
//       RST         ??          PB8         //???????ï¿½ï¿½???????
//       CS          ??          PB9         //??????????????
**************************************************************************************************/	
#include "lcd.h"
#include "stdlib.h"
#include "delay.h"	 
#include "spi.h"
#include "font.h"

/*****************************************************************************
 * @name       :void LCD_WR_REG(u8 data)
 * @date       :2018-08-09 
 * @function   :Write an 8-bit command to the LCD screen
 * @parameters :data:Command value to be written
 * @retvalue   :None
******************************************************************************/
void LCD_WR_REG(u8 data)
{ 
   LCD_CS_CLR;     	  
   SPI_WriteByte(SPI1,data,0);
   LCD_CS_SET;	
}

/*****************************************************************************
 * @name       :void LCD_WR_DATA(u8 data)
 * @date       :2018-08-09 
 * @function   :Write an 8-bit data to the LCD screen
 * @parameters :data:data value to be written
 * @retvalue   :None
******************************************************************************/
void LCD_WR_DATA(u8 data)
{
   LCD_CS_CLR;
	 SPI_WriteByte(SPI1,data,1);
   LCD_CS_SET;
}
   

/*****************************************************************************
 * @name       :void LCD_WriteRAM_Prepare(void)
 * @date       :2018-08-09 
 * @function   :Write GRAM
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	 
void LCD_WriteRAM_Prepare(void)
{
	LCD_WR_REG(0x2c);
}	 


/*****************************************************************************
 * @name       :void LCD_GPIOInit(void)
 * @date       :2018-08-09 
 * @function   :Initialization LCD screen GPIO
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	
void LCD_GPIOInit(void)
{
	GPIO_InitTypeDef  GPIO_InitStructure;	      
	RCC_APB2PeriphClockCmd( RCC_APB2Periph_GPIOB ,ENABLE);	//???GPIOB???
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6| GPIO_Pin_7| GPIO_Pin_8|GPIO_Pin_9; //GPIOB6,7,8,9
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;   //???????
	GPIO_Init(GPIOB, &GPIO_InitStructure);//?????
}

/*****************************************************************************
 * @name       :void LCD_RESET(void)
 * @date       :2018-08-09 
 * @function   :Reset LCD screen
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	
void LCD_RESET(void)
{
	LCD_RST_CLR;
	delay_ms(100);	
	LCD_RST_SET;
	delay_ms(50);
}

/*****************************************************************************
 * @name       :void LCD_RESET(void)
 * @date       :2018-08-09 
 * @function   :Initialization LCD screen
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	 	 
void LCD_Init(void)
{  
	SPI1_Init(); //???SPI1?????
	LCD_GPIOInit();//LCD GPIO?????										 
 	LCD_RESET(); //LCD ??ï¿½ï¿½
	
	//************* ST7586S?????**********//		
	LCD_WR_REG(0x11); //????????
	LCD_WR_REG(0xC0); // ???? VOP
	LCD_WR_DATA(0xf1); // ???? VOP ?????? 8 ï¿½ï¿½????? 9 ï¿½ï¿½??,???????? 0.03667V
	LCD_WR_DATA(0x00); // ???? VOP ?????? 9 ï¿½ï¿½?????????ï¿½ï¿½
	LCD_WR_REG(0xC3); // ???? BIAS
	LCD_WR_DATA(0x02); // 00??BIAS = 1/14 02 = 1/12
	LCD_WR_REG(0xC4); // ???????????
	LCD_WR_DATA(0x07); // 07??8 ???
	LCD_WR_REG(0xD0); // ????????ï¿½ï¿½
	LCD_WR_DATA(0x1D); // ????????ï¿½ï¿½
	LCD_WR_REG(0xB5); // N-Line = 13
	LCD_WR_DATA(0x00); // 8d
	LCD_WR_REG(0x38); // 0x38?????????????? 0x39: ????????????
	LCD_WR_REG(0x3A); // ???? DDRAM ???????????4 ??????16 ??????
	LCD_WR_DATA(0x02); // 0x03:16 ??????0x02:4 ???????????

	LCD_WR_REG(0x36); // ??????????
	LCD_WR_DATA(0x00); // ??????????:MX=1,MY=1: ?????????????????????
	LCD_WR_REG(0xB0); // Duty ????
	LCD_WR_DATA(0x9f); // Duty ????:1/160
	LCD_WR_REG(0x20); // ?????????OFF
	LCD_WR_REG(0xf1); //???????????ï¿½ï¿½?????
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_REG(0xb1);  // ????????????
	LCD_WR_DATA(0x00); // ??????????????? COM0 ???
	LCD_WR_REG(0x29);  // ???????DISPLAY ON
	
	LCD_LED=1;     //????????	 
	LCD_Clear();   //????????
}
 

/*ï¿½ï¿½ LCD ???ï¿½ï¿½????X ???????ï¿½ï¿½????Y ???????ï¿½ï¿½????x_total,y_total ?????ï¿½ï¿½?????ï¿½ï¿½????????????? */
void lcd_address(u16 x,u16 y,u16 x_total,u16 y_total)
{
	u16 x_end,y_end;
	
	x_end=x+(x_total-1)/3;
	y_end=y+y_total-1;
	
	LCD_WR_REG(0x2a);
	LCD_WR_DATA((x>>8)&0x00ff);
	LCD_WR_DATA(x&0x00ff);
	LCD_WR_DATA(x_end>>8&0x00ff);
	LCD_WR_DATA(x_end&0x00ff);
	LCD_WR_REG(0x2b);
	LCD_WR_DATA((y>>8)&0x00ff);
	LCD_WR_DATA(y&0x00ff);
	LCD_WR_DATA(y_end>>8&0x00ff);
	LCD_WR_DATA(y_end&0x00ff);
}	
	
	
//????????????? 3 ??????????????????? SEG0??SEG1??SEG2???? 3 ?????????????ï¿½ï¿½????????????
//???????????? 1 ?ï¿½ï¿½????????D7 D6 D5 D4 D3 D2 D1 D0?? ?ï¿½ï¿½?? 3 ï¿½ï¿½---D7 D6 D5, ?? 2 ?????? 3 ï¿½ï¿½---D4 D3 D2,?? 3 ???????ï¿½ï¿½---D1 D0??
void transfer_mono_data_3pixel(u8 mono_data)
{
	u8 gray_data=0;
	
	if(mono_data&0x80)
	{
		gray_data=0xe0; //?????? 11100000??????? D7??D6??D5 ???
	}
	else
	{
		gray_data=0;
	}
	mono_data<<=1;
	if(mono_data&0x80)
	{
		gray_data+=0x1c; //?????? 00011100??????? D4??D3??D2 ???
	}
	else;
	mono_data<<=1;
	if(mono_data&0x80)
	{
		gray_data+=0x03; //?????? 00000011??????? D1??D0 ???
	}
	else;
	LCD_WR_DATA(gray_data); //display 3 dots (seg_N,seg_N+1,seg_N+2)
}	

//??? 6 ??????
void transfer_mono_data_6pixel(u8 dat1)
{
	transfer_mono_data_3pixel(dat1);
	transfer_mono_data_3pixel(dat1<<3);
}
//??? 8 ??????
void transfer_mono_data_8pixel(u8 dat1)
{
	transfer_mono_data_3pixel(dat1);//???? dat1 ?? D7\D6\D5 ?? 3 ï¿½ï¿½????? 3 ??????(?? 1??2??3 ????????????????ï¿½ï¿½???????+1 ??
	transfer_mono_data_3pixel(dat1<<3);//???? dat1 ?? D4\D3\D2 ?? 3 ï¿½ï¿½????? 3 ??????(?? 4??5??6 ????????????????ï¿½ï¿½???????+1 ??
	transfer_mono_data_3pixel(dat1<<6);//???? dat1 ?? D1\D0 ?? 2 ï¿½ï¿½????? 3 ??????(?? 7??8??9 ?????????????
	//?????????? IC ??????ï¿½ï¿½???? 3 ??????????????????? 7??8 ?????????????? 9 ???????????????? 9 ????????????? 9 ?????????0??
	//????? 9 ?????????????????????????????
}
//??? 9 ??????
void transfer_mono_data_9pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_6pixel(dat1);//????? 6 ??????
	transfer_mono_data_3pixel((dat1<<6)|(dat2>>2)); //??? dat1 ?? D1??D0 ?? dat2 ?? D7 ï¿½ï¿½????? 3 ??????(?? 7??8??9 ????????????????ï¿½ï¿½???????+1 ??
}
//??? 12 ??????
void transfer_mono_data_12pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_9pixel(dat1,dat2);//????? 9 ??????
	transfer_mono_data_3pixel(dat2<<1); //???? dat2 ?? D6\D5\D4 ?? 3 ï¿½ï¿½??????? 10??11??12 ???????????????????ï¿½ï¿½???????+1??
}
//??? 15 ??????
void transfer_mono_data_15pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_12pixel(dat1,dat2); //????? 12 ??????
	transfer_mono_data_3pixel(dat2<<4); //???? dat2 ?? D3\D2\D1 ?? 3 ï¿½ï¿½??????? 13??14??15 ?????????????????ï¿½ï¿½???????+1??
}
//??? 16 ??????
void transfer_mono_data_16pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_15pixel(dat1,dat2); //????? 15 ??????
	transfer_mono_data_3pixel(dat2<<7); //????? 16 ??????,??? dat2 ?? D0 ï¿½ï¿½??
//?????????? IC ??????ï¿½ï¿½???? 3 ??????????????????? 16 ?????????????? 17??18 ???????????????? 18 ?????? ???????17??18 ?????????0??
//????? 17??18 ?????????????????????????????
}
//??? 18 ??????
void transfer_mono_data_18pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_15pixel(dat1,dat2); //????? 15 ??????
	transfer_mono_data_3pixel((dat2<<7)|(dat3>>1)); //???? dat2 ?? D0 ?? dat3 ?? D7??D6 ?? 3 ï¿½ï¿½??????? 16??17??18 ?????????????????ï¿½ï¿½???????+1 ??
}
//??? 21 ??????
void transfer_mono_data_21pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_18pixel(dat1,dat2,dat3); //????? 18 ??????
	transfer_mono_data_3pixel(dat3<<2); //???? dat3 ?? D5??D4??D3 ?? 3 ï¿½ï¿½??????? 19??20??21 ?????????????????ï¿½ï¿½???????+1??
}
//??? 24 ????????????
void transfer_mono_data_24pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_21pixel(dat1,dat2,dat3); //????? 21 ??????
	transfer_mono_data_3pixel(dat3<<5); //???? dat3 ?? D2??D1??D0 ?? 3 ï¿½ï¿½??????? 22??23??24 ?????????????????ï¿½ï¿½???????+1??
}
//??? 27 ??????
void transfer_mono_data_27pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_3pixel(dat4); //???? dat4 ?? D7??D6??D5 ?? 3 ï¿½ï¿½??????? 25?? 26??27 ?????????????????ï¿½ï¿½???????+1??
}
//??? 30 ??????
void transfer_mono_data_30pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_6pixel(dat4); //????? 6 ??????24+6=30
}
//??? 32 ??????
void transfer_mono_data_32pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_8pixel(dat4); //????? 8 ??????24+8=32
//?????????? IC ??????ï¿½ï¿½???? 3 ??????????????????? 31??32 ?????????????? 33 ???????????????? 33 ?????? ???????33 ?????????0??
//????? 33 ?????????????????????????????
}
//??? 33 ??????
void transfer_mono_data_33pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4,u8 dat5)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_9pixel(dat4,dat5); //????? 9 ??????
}
//??? 48 ??????
void transfer_mono_data_48pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4,u8 dat5,u8 dat6)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_24pixel(dat4,dat5,dat6); //????? 24 ??????
}	
	

//????????????? 3 ??????? 4 ??????????????? SEG0?? SEG1??SEG2,?? 3 ?????????????ï¿½ï¿½???? ??????
//????????(gray_data)???SEG0 ????? 3 ï¿½ï¿½??D7?? D6??D5??,SEG1 ????? 3 ï¿½ï¿½??D4??D3??D2),SEG2 ???????ï¿½ï¿½??D1??D0????
void transfer_gray_data_3pixel(u8 dat1)
{
	u8 gray_data;
	
	gray_data=dat1&0xc0;; //?? gray_data ?? D7??D6 ???(=dat1 ?? D7??D6)
	if((dat1&0xc0)==0xc0)
	{
		gray_data|=0x20; //?? gray_data ?? D5 ??????? dat1 ?? D7??D6 ???? 1 ?????gray_data ?? D5=1,?? dat1 ?? D7\D6 ?????? 1 ?????gray_data ?? D5=0
	}
	gray_data|=((dat1>>1)&0x18); //?? gray_data ?? D4??D3 ?????=dat1 ?? D5??D4)
	if((dat1&0x30)==0x30)
	{
		gray_data|=0x04; //?? gray_data ?? D2 ??????? dat1 ?? D5??D4 ???? 1 ?????gray_data ?? D2=1,?? dat1 ?? D7??D6 ?????? 1 ?????gray_data ?? D2=0
	}
	gray_data|=((dat1>>2)&0x03); //?? gray_data ?? D1??D0 ???(=dat1 ?? D3??D2)
	LCD_WR_DATA(gray_data); //???? 1 ??????????????????? IC,????? 3 ??????????(seg_N,seg_N+1,seg_N+2)
}


//????????????? 12 ??????? 4 ????????????? SEG0??SEG1??SEG2......SEG9??SEG10??SEG11???? 12 ???????? 4 ???ï¿½ï¿½????
//? 2 ï¿½ï¿½?????????????12 ?????????2*12=24 ï¿½ï¿½???? 3 ?????:dat1??dat2??dat3
void transfer_gray_data_12pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_gray_data_3pixel(dat1); //??? 3 ??????(seg_N,seg_N+1,SEG_N+2)
	transfer_gray_data_3pixel((dat1<<6)|(dat2>>2)); //??? 3 ??????(seg_N+3,seg_N+4,SEG_N+5)
	transfer_gray_data_3pixel((dat2<<4)|(dat3>>4)); //??? 3 ??????(seg_N+6,seg_N+7,SEG_N+8)
	transfer_gray_data_3pixel(dat3<<2); //??? 3 ??????(seg_N+9,seg_N+10,SEG_N+11)
}


/*????*/
void LCD_Clear(void)
{
	int i,j;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<160;i++)
	{
		for(j=0;j<20;j++)
		{
			transfer_mono_data_18pixel(0x00,0x00,0x00); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//??? 240*160 ????????
void disp_240x160(u8 *dp)
{
	u16 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	for(i=0;i<160;i++)
	{
		for(j=0;j<10;j++)//??? 10 ?ï¿½ï¿½??????? 24 ???????? 240 ??????
		{
			dat1=*dp;dp++;
			dat2=*dp;dp++;
			dat3=*dp;dp++;
			transfer_mono_data_24pixel(dat1,dat2,dat3); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//===?????????ï¿½ï¿½??????????????????????????????????=====
void test_display(u8 dat1,u8 dat2,u8 dat3)
{
	u16 i,j;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	for(i=0;i<160;i++)
	{
		for(j=0;j<10;j++)//??? 10 ?ï¿½ï¿½??????? 24 ???????? 240 ??????
		{
			transfer_mono_data_24pixel(dat1,dat2,dat3); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//??? 240*160 ????? 4 ???????
void disp_4gray_240x160(u8 *dp)
{
	u8 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(0,0,240,160); //
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<160;i++)
	{
		for(j=0;j<20;j++)//??? 20 ?ï¿½ï¿½??????? 12 ???????? 20*12=240 ??????
		{
			dat1=*dp;dp++;
			dat2=*dp;dp++;
			dat3=*dp;dp++;
			transfer_gray_data_12pixel(dat1,dat2,dat3); //????????? 4 ?????????? 4*3=12 ??????
		}
	}
}



/**
 * @brief  ?????ï¿½ï¿½????????8x16?????
 * @param  x: ?????? 0-239
 * @param  y: ?????? 0-159
 * @param  num: ?????????ASCII??
 */
void LCD_ShowChar(u16 x, u16 y, u8 num)
{
    u8 temp, i;
    const u8 *font_ptr = NULL; // ?????????????????

    // ?ï¿½ï¿½????????????????????????
    if (num >= '0' && num <= '9')
    {
        // ?????????
        font_ptr = &asc2_1608_number[num - '0'][0];
    }
		else if (num == '.' )
    {
        // ??????ï¿½ï¿½???
        font_ptr = &asc2_1608_number[10][0];
    }
    
    else if (num >= 'A' && num <= 'Z')
    {
        // ??????ï¿½ï¿½???
        font_ptr = &asc2_1608_UppL[num - 'A'][0];
    }
    // else if (num >= 'a' && num <= 'z')
    // {
    //     // ??????????????ï¿½ï¿½ï¿½ï¿½?????????????????????
    //     font_ptr = &asc2_1608_LowL[num - 'a'][0];
    // }
	else if (num == ' ')
    {
        // ????????????????????????
        // ????????????? 8x16 ????????
        lcd_address(x, y, 8, 16);
        LCD_WriteRAM_Prepare();
        for (i = 0; i < 16; i++)
        {
            transfer_mono_data_8pixel(0x00); // ?????0????????????
        }
        return; // ???????????????
    }
    else
    {
        // ????????????????????????????????????????????
        // ?????????????????????ï¿½ï¿½????????????????????????
        return; // ????????????ï¿½ï¿½???????
    }

    // ???????????????
    if (font_ptr)
    {
        lcd_address(x, y, 8, 16); // ???????????? 8x16
        LCD_WriteRAM_Prepare();   // ???ï¿½ï¿½GRAM

        for (i = 0; i < 16; i++) // ???16?ï¿½ï¿½???????8x16?????
        {
            temp = font_ptr[i]; // ????????8???????????
            transfer_mono_data_8pixel(temp); // ????????????????????????????8????????????????
        }
    }
}


/**
 * @brief  ï¿½ï¿½Ö¸ï¿½ï¿½Î»ï¿½ï¿½ï¿½ï¿½Ê¾Ò»ï¿½ï¿½8x16ï¿½ï¿½ï¿½Ö·ï¿½
 * @param  x: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 0-239
 * @param  y: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 0-159
 * @param  num: Òªï¿½ï¿½Ê¾ï¿½ï¿½ï¿½Ö·ï¿½ASCIIï¿½ï¿½
 */
void LCD_ShowChar_Large(u16 x, u16 y, u8 num)
{
    u8 temp, i;
    const u8 *font_ptr = NULL; // ï¿½È´ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Õµï¿½ï¿½Ö¿ï¿½Ö¸ï¿½ï¿½

    // ï¿½Ð¶ï¿½ï¿½Ö·ï¿½ï¿½ï¿½ï¿½Í£ï¿½ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½È·ï¿½ï¿½ï¿½Ö¿ï¿½ï¿½ï¿½?
    if (num >= '0' && num <= '9')
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿??
        font_ptr = &asc2_1608_number_Large[num - '0'][0];
    }
		else if (num == '.' )
    {
        // ??????ï¿½ï¿½???
        font_ptr = &asc2_1608_number_Large[10][0];
    }
    else if (num >= 'A' && num <= 'Z')
    {
        // ï¿½ï¿½ï¿½ï¿½Ç´ï¿½Ð´ï¿½ï¿½ï¿½?
        font_ptr = &asc2_1608_UppL[num - 'A'][0];
    }
    // else if (num >= 'a' && num <= 'z')
    // {
    //     // ï¿½ï¿½ï¿½ï¿½Ôºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¡Ð´ï¿½ï¿½Ä¸ï¿½Ö¿ï¿??ï¿½ï¿½ï¿½ï¿½È¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½ï¿½
    //     font_ptr = &asc2_1608_LowL[num - 'a'][0];
    // }
	else if (num == ' ')
    {
        // ï¿½ï¿½ï¿½ï¿½Ç¿Õ¸ï¿½ï¿½ï¿½ï¿½â´¦ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¿ï¿??
        // Ö±ï¿½ï¿½×¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ 8x16 ï¿½Ä¿Õ°ï¿½ï¿½ï¿½ï¿½ï¿½
        lcd_address(x, y, 30, 77);
        LCD_WriteRAM_Prepare();
        for (i = 0; i < 77; i++)
        {
            transfer_mono_data_16pixel(0x00,0x00); // ï¿½ï¿½ï¿½ï¿½È«0ï¿½ï¿½ï¿½Ý£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½É«
        }
        return; // ï¿½Õ¸ï¿½ï¿½ï¿½ï¿½ï¿½Ï£ï¿½Ö±ï¿½Ó·ï¿½ï¿½ï¿??
    }
    else
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ¸ñ¡¢±ï¿½ï¿½ï¿½ï¿½ÅµÈ£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½ï¿½?
        // ï¿½ï¿½Ò²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½Î´Öªï¿½Ö·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ä£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        return; // Ö±ï¿½Ó·ï¿½ï¿½Ø£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ðºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
    }

    // ï¿½ï¿½ï¿½ï¿½Òµï¿½ï¿½ËºÏ·ï¿½ï¿½ï¿½ï¿½Ö¿ï¿??
    if (font_ptr)
    {
        lcd_address(x, y, 30, 60); // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¾ï¿½ï¿½ï¿½ï¿½Îª 8x16
        LCD_WriteRAM_Prepare();   // ×¼ï¿½ï¿½Ð´GRAM

        for (i = 0; i < 60; i++) // Ñ­ï¿½ï¿½16ï¿½Ð£ï¿½ï¿½ï¿½Ê¾Ò»ï¿½ï¿½8x16ï¿½ï¿½ï¿½Ö·ï¿½
        {
            //temp = font_ptr[i]; // È¡ï¿½ï¿½ï¿½ï¿½Ç°ï¿½ï¿½8ï¿½ï¿½ï¿½ï¿½ï¿½Øµï¿½ï¿½ï¿½ï¿½ï¿½
            //transfer_mono_data_8pixel(temp); // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Äºï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½8ï¿½ï¿½ï¿½ï¿½ï¿½Øµï¿½ï¿½ï¿½ï¿½Ý·ï¿½ï¿½Í³ï¿½È¥
			u8 dat1 = font_ptr[i * 4];     // 
        	u8 dat2 = font_ptr[i * 4 + 1]; // 
			u8 dat3 = font_ptr[i * 4 + 2]; // 
			u8 dat4 = font_ptr[i * 4 + 3];     // 
        	transfer_mono_data_30pixel(dat1, dat2, dat3, dat4);
		}
    }
}


void LCD_ShowFloat_70(u16 x, u16 y, float value)
{
    char buf[6]; // æœ€å¤?"70.0\0"
    int len;
    sprintf(buf, "%4.1f", value); // å³å?¹é½ï¼Œå?½åº¦4ï¼?1ä½å°æ•?
    len = strlen(buf);

    // æ“¦é™¤æ˜¾ç¤ºåŒºåŸŸ
    for (int i = 0; i < 4; i++)
        LCD_ShowChar(x + i * LCD_Show_Xpos, y, ' ');

    // å³å?¹é½æ˜¾ç¤º
    for (int i = 0; i < len; i++)
        LCD_ShowChar(x + (i + (4 - len)) * LCD_Show_Xpos, y, buf[i]);
}

// å¤§å­—å·ï¼Œå­—ç?¦å?½åº¦gap
void LCD_ShowFloat_70_Large(u16 x, u16 y, float value)
{
    char buf[6];
    int len = 32;
    sprintf(buf, "%4.1f", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar_Large(x + i * LCD_Show_Large_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar_Large(x + (i + (4 - len)) * LCD_Show_Large_Xpos, y, buf[i]);
}

// æ™?é€šå­—å·æ•´æ•°ï¼Œæœ€å¤?4ä½ï¼Œå­—ç?¦å?½åº¦8
void LCD_ShowInt_3000(u16 x, u16 y, int value)
{
    char buf[5];
    int len;
    sprintf(buf, "%4d", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar(x + i * LCD_Show_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar(x + (i + (4 - len)) * LCD_Show_Xpos, y, buf[i]);
}

// å¤§å­—å·æ•´æ•°ï¼Œæœ€å¤?4ä½ï¼Œå­—ç?¦å?½åº¦gap
void LCD_ShowInt_3000_Large(u16 x, u16 y, int value)
{
    char buf[5];
    int len = 32;
    sprintf(buf, "%4d", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar_Large(x + i * LCD_Show_Large_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar_Large(x + (i + (4 - len)) * LCD_Show_Large_Xpos, y, buf[i]);
}


// é€šç”¨æµ?ç‚¹æ•°é’³ä½å‡½æ•°
float clamp_float(float value, float min, float max)
{
	if (value < min) return min;
	if (value > max) return max;
	return value;
}

int8_t clamp_int8(int8_t value, int8_t min, int8_t max)
{
    if (value < min) return min;
    if (value > max) return max;
    return value;
}

int16_t clamp_int16(int16_t value, int16_t min, int16_t max)
{
    if (value < min) return min;
    if (value > max) return max;
    return value;
}
/*-------------------------------------Graphic Drawing------------------------------------------------------------------*/

// µÍ×ÊÔ´µ¥µã»­µã/Çåµãº¯Êý
void LCD_Update3Pixel(uint16_t x, uint16_t y, uint8_t set)
{
    uint8_t group = x / 3;      // 3ÏñËØÒ»×é
    uint8_t bit = x % 3;        // ×éÄÚµÚ¼¸¸öÏñËØ
    uint8_t data = 0x00;

    // Ö»ÉèÖÃÄ¿±êÏñËØ
    data = (1 << (7 - bit * 3)); // D7/D4/D1·Ö±ð¶ÔÓ¦bit=0/1/2

    lcd_address(group, y, 1, 1);
    LCD_WriteRAM_Prepare();
    if (set)
        transfer_mono_data_3pixel(data); // »­µã
    else
        transfer_mono_data_3pixel(0x00); // Çåµã£¨Ö»Çå±¾×éËùÓÐµã£¬ÎÞ·¨µ¥¶ÀÇåÒ»¸öµã£¬Ó²¼þÏÞÖÆ£©
}

// »­µ¥µã£¨Ö»ÏÔÊ¾Ä¿±êµã£¬ÆäËûµãÇå¿Õ£©
void LCD_DrawPoint(uint16_t x, uint16_t y)
{
    uint8_t group = x / 3;
    uint8_t bit = x % 3;
    static uint8_t line_buf[80];
    for (int i = 0; i < 80; i++) line_buf[i] = 0x00; // Çå¿ÕÕûÐÐ
    // ÉèÖÃÄ¿±êµã
    line_buf[group] = (1 << (7 - bit * 3));
    lcd_address(0, y, 240, 1);
    LCD_WriteRAM_Prepare();
    for (int i = 0; i < 80; i++)
        transfer_mono_data_3pixel(line_buf[i]);
}

void LCD_DrawLine_Mode(uint16_t x, uint16_t y)
{
    lcd_address(x, y, 1, 1);
    LCD_WriteRAM_Prepare();
    transfer_mono_data_21pixel(0xFF,0xFF,0xFF); // ÏÔÊ¾Ò»¸öµã
}


// Çå³ýµ¥µã£¨ÕûÐÐÇå¿Õ£©
void LCD_ClearPoint(uint16_t x, uint16_t y)
{
    lcd_address(0, y, 240, 1);
    LCD_WriteRAM_Prepare();
    for (int i = 0; i < 80; i++)
        transfer_mono_data_3pixel(0x00);
}

// // »­µãº¯Êý£¨ÈçÒÑÓÐ¿ÉÖ±½ÓÓÃ£©
// void LCD_DrawPoint(uint16_t x, uint16_t y)
// {
//     lcd_address(x, y, 1, 1);
//     LCD_WriteRAM_Prepare();
//     transfer_mono_data_9pixel(0xFF); // ÏÔÊ¾Ò»¸öµã
// }

// // Çå³ýÒ»¸öÏñËØµã£¨ÏÔÊ¾ÎªºÚÉ«/±³¾°É«£©
// void LCD_ClearPoint(uint16_t x, uint16_t y)
// {
//     lcd_address(x+1, y, 1, 1);
//     LCD_WriteRAM_Prepare();
//     transfer_mono_data_8pixel(0x00); // Çå³ýÒ»¸öµã
// }

// Ö±Ïß»æÖÆ£¨BresenhamËã·¨£©
void LCD_DrawLine(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1)
{
    int dx = abs(x1 - x0), dy = abs(y1 - y0);
    int sx = x0 < x1 ? 1 : -1;
    int sy = y0 < y1 ? 1 : -1;
    int err = (dx > dy ? dx : -dy) / 2, e2;

    while (1) {
        LCD_DrawPoint(x0, y0);
        if (x0 == x1 && y0 == y1) break;
        e2 = err;
        if (e2 > -dx) { err -= dy; x0 += sx; }
        if (e2 < dy) { err += dx; y0 += sy; }
    }
}

// Ö»»­Ô²µÄ1/4£¨ÏóÏÞ1~4£©£¬ÓÃÓÚÔ²½Ç
void LCD_DrawCirclePart(uint16_t xc, uint16_t yc, uint16_t r, uint8_t quadrant)
{
    int x = 0, y = r;
    int d = 3 - 2 * r;
    while (x <= y) {
        switch (quadrant) {
            case 1: // ×óÉÏ
                LCD_DrawPoint(xc - x, yc - y);
                LCD_DrawPoint(xc - y, yc - x);
                break;
            case 2: // ÓÒÉÏ
                LCD_DrawPoint(xc + x, yc - y);
                LCD_DrawPoint(xc + y, yc - x);
                break;
            case 3: // ×óÏÂ
                LCD_DrawPoint(xc - y, yc + x);
                LCD_DrawPoint(xc - x, yc + y);
                break;
            case 4: // ÓÒÏÂ
                LCD_DrawPoint(xc + x, yc + y);
                LCD_DrawPoint(xc + y, yc + x);
                break;
        }
        if (d < 0) d += 4 * x + 6;
        else { d += 4 * (x - y) + 10; y--; }
        x++;
    }
}

// »æÖÆÔ²½Ç¾ØÐÎ
void LCD_DrawRoundRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint8_t radius, uint8_t lineWidth)
{
    // »­ËÄÌõ±ß£¨È¥µôÔ²½Ç²¿·Ö£©
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        // ÉÏ±ß
        LCD_DrawLine(x + radius + lw, y + lw, x + width - radius - lw - 1, y + lw);
        // ÏÂ±ß
        LCD_DrawLine(x + radius + lw, y + height - lw - 1, x + width - radius - lw - 1, y + height - lw - 1);
        // ×ó±ß
        LCD_DrawLine(x + lw, y + radius + lw, x + lw, y + height - radius - lw - 1);
        // ÓÒ±ß
        LCD_DrawLine(x + width - lw - 1, y + radius + lw, x + width - lw - 1, y + height - radius - lw - 1);
    }
    // »­ËÄ¸öÔ²½Ç
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        LCD_DrawCirclePart(x + radius, y + radius, radius - lw, 1); // ×óÉÏ
        LCD_DrawCirclePart(x + width - radius - 1, y + radius, radius - lw, 2); // ÓÒÉÏ
        LCD_DrawCirclePart(x + radius, y + height - radius - 1, radius - lw, 3); // ×óÏÂ
        LCD_DrawCirclePart(x + width - radius - 1, y + height - radius - 1, radius - lw, 4); // ÓÒÏÂ
    }
}

// »æÖÆÆÕÍ¨¾ØÐÎ
void LCD_DrawRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint8_t lineWidth)
{
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        // ÉÏ±ß
        LCD_DrawLine(x + lw, y + lw, x + width - lw - 1, y + lw);
        // ÏÂ±ß
        LCD_DrawLine(x + lw, y + height - lw - 1, x + width - lw - 1, y + height - lw - 1);
        // ×ó±ß
        LCD_DrawLine(x + lw, y + lw, x + lw, y + height - lw - 1);
        // ÓÒ±ß
        LCD_DrawLine(x + width - lw - 1, y + lw, x + width - lw - 1, y + height - lw - 1);
    }
}