/****************************************************************************************************
//=========================================???????================================================//
//     LCD???                STM32?????
//      VCC          ??          3.3V         //???
//      GND          ??          GND          //?????
//=======================================??????????????==========================================//
//?????????????????????SPI????
//     LCD???                STM32?????    
//    SDI(MOSI)      ??          PA7         //?????SPI????????锟斤拷??? 
//       LED         ??          PB6         //???????????????
//       SCK         ??          PA5         //?????SPI??????????
//      DC/RS        ??          PB7         //?????????/???????????NC??
//       RST         ??          PB8         //???????锟斤拷???????
//       CS          ??          PB9         //??????????????
**************************************************************************************************/	
#include "lcd.h"
#include "stdlib.h"
#include "delay.h"	 
#include "spi.h"
#include "font.h"

/*****************************************************************************
 * @name       :void LCD_WR_REG(u8 data)
 * @date       :2018-08-09 
 * @function   :Write an 8-bit command to the LCD screen
 * @parameters :data:Command value to be written
 * @retvalue   :None
******************************************************************************/
void LCD_WR_REG(u8 data)
{ 
   LCD_CS_CLR;     	  
   SPI_WriteByte(SPI1,data,0);
   LCD_CS_SET;	
}

/*****************************************************************************
 * @name       :void LCD_WR_DATA(u8 data)
 * @date       :2018-08-09 
 * @function   :Write an 8-bit data to the LCD screen
 * @parameters :data:data value to be written
 * @retvalue   :None
******************************************************************************/
void LCD_WR_DATA(u8 data)
{
   LCD_CS_CLR;
	 SPI_WriteByte(SPI1,data,1);
   LCD_CS_SET;
}
   

/*****************************************************************************
 * @name       :void LCD_WriteRAM_Prepare(void)
 * @date       :2018-08-09 
 * @function   :Write GRAM
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	 
void LCD_WriteRAM_Prepare(void)
{
	LCD_WR_REG(0x2c);
}	 


/*****************************************************************************
 * @name       :void LCD_GPIOInit(void)
 * @date       :2018-08-09 
 * @function   :Initialization LCD screen GPIO
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	
void LCD_GPIOInit(void)
{
	GPIO_InitTypeDef  GPIO_InitStructure;	      
	RCC_APB2PeriphClockCmd( RCC_APB2Periph_GPIOB ,ENABLE);	//???GPIOB???
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6| GPIO_Pin_7| GPIO_Pin_8|GPIO_Pin_9; //GPIOB6,7,8,9
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;   //???????
	GPIO_Init(GPIOB, &GPIO_InitStructure);//?????
}

/*****************************************************************************
 * @name       :void LCD_RESET(void)
 * @date       :2018-08-09 
 * @function   :Reset LCD screen
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	
void LCD_RESET(void)
{
	LCD_RST_CLR;
	delay_ms(100);	
	LCD_RST_SET;
	delay_ms(50);
}

/*****************************************************************************
 * @name       :void LCD_RESET(void)
 * @date       :2018-08-09 
 * @function   :Initialization LCD screen
 * @parameters :None
 * @retvalue   :None
******************************************************************************/	 	 
void LCD_Init(void)
{  
	SPI1_Init(); //???SPI1?????
	LCD_GPIOInit();//LCD GPIO?????										 
 	LCD_RESET(); //LCD ??锟斤拷
	
	//************* ST7586S?????**********//		
	LCD_WR_REG(0x11); //????????
	LCD_WR_REG(0xC0); // ???? VOP
	LCD_WR_DATA(0xf1); // ???? VOP ?????? 8 锟斤拷????? 9 锟斤拷??,???????? 0.03667V
	LCD_WR_DATA(0x00); // ???? VOP ?????? 9 锟斤拷?????????锟斤拷
	LCD_WR_REG(0xC3); // ???? BIAS
	LCD_WR_DATA(0x02); // 00??BIAS = 1/14 02 = 1/12
	LCD_WR_REG(0xC4); // ???????????
	LCD_WR_DATA(0x07); // 07??8 ???
	LCD_WR_REG(0xD0); // ????????锟斤拷
	LCD_WR_DATA(0x1D); // ????????锟斤拷
	LCD_WR_REG(0xB5); // N-Line = 13
	LCD_WR_DATA(0x00); // 8d
	LCD_WR_REG(0x38); // 0x38?????????????? 0x39: ????????????
	LCD_WR_REG(0x3A); // ???? DDRAM ???????????4 ??????16 ??????
	LCD_WR_DATA(0x02); // 0x03:16 ??????0x02:4 ???????????

	LCD_WR_REG(0x36); // ??????????
	LCD_WR_DATA(0x00); // ??????????:MX=1,MY=1: ?????????????????????
	LCD_WR_REG(0xB0); // Duty ????
	LCD_WR_DATA(0x9f); // Duty ????:1/160
	LCD_WR_REG(0x20); // ?????????OFF
	LCD_WR_REG(0xf1); //???????????锟斤拷?????
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_DATA(0x15);
	LCD_WR_REG(0xb1);  // ????????????
	LCD_WR_DATA(0x00); // ??????????????? COM0 ???
	LCD_WR_REG(0x29);  // ???????DISPLAY ON
	
	LCD_LED=1;     //????????	 
	LCD_Clear();   //????????
}
 

/*锟斤拷 LCD ???锟斤拷????X ???????锟斤拷????Y ???????锟斤拷????x_total,y_total ?????锟斤拷?????锟斤拷????????????? */
void lcd_address(u16 x,u16 y,u16 x_total,u16 y_total)
{
	u16 x_end,y_end;
	
	x_end=x+(x_total-1)/3;
	y_end=y+y_total-1;
	
	LCD_WR_REG(0x2a);
	LCD_WR_DATA((x>>8)&0x00ff);
	LCD_WR_DATA(x&0x00ff);
	LCD_WR_DATA(x_end>>8&0x00ff);
	LCD_WR_DATA(x_end&0x00ff);
	LCD_WR_REG(0x2b);
	LCD_WR_DATA((y>>8)&0x00ff);
	LCD_WR_DATA(y&0x00ff);
	LCD_WR_DATA(y_end>>8&0x00ff);
	LCD_WR_DATA(y_end&0x00ff);
}	
	
	
//????????????? 3 ??????????????????? SEG0??SEG1??SEG2???? 3 ?????????????锟斤拷????????????
//???????????? 1 ?锟斤拷????????D7 D6 D5 D4 D3 D2 D1 D0?? ?锟斤拷?? 3 锟斤拷---D7 D6 D5, ?? 2 ?????? 3 锟斤拷---D4 D3 D2,?? 3 ???????锟斤拷---D1 D0??
void transfer_mono_data_3pixel(u8 mono_data)
{
	u8 gray_data=0;
	
	if(mono_data&0x80)
	{
		gray_data=0xe0; //?????? 11100000??????? D7??D6??D5 ???
	}
	else
	{
		gray_data=0;
	}
	mono_data<<=1;
	if(mono_data&0x80)
	{
		gray_data+=0x1c; //?????? 00011100??????? D4??D3??D2 ???
	}
	else;
	mono_data<<=1;
	if(mono_data&0x80)
	{
		gray_data+=0x03; //?????? 00000011??????? D1??D0 ???
	}
	else;
	LCD_WR_DATA(gray_data); //display 3 dots (seg_N,seg_N+1,seg_N+2)
}	

//??? 6 ??????
void transfer_mono_data_6pixel(u8 dat1)
{
	transfer_mono_data_3pixel(dat1);
	transfer_mono_data_3pixel(dat1<<3);
}
//??? 8 ??????
void transfer_mono_data_8pixel(u8 dat1)
{
	transfer_mono_data_3pixel(dat1);//???? dat1 ?? D7\D6\D5 ?? 3 锟斤拷????? 3 ??????(?? 1??2??3 ????????????????锟斤拷???????+1 ??
	transfer_mono_data_3pixel(dat1<<3);//???? dat1 ?? D4\D3\D2 ?? 3 锟斤拷????? 3 ??????(?? 4??5??6 ????????????????锟斤拷???????+1 ??
	transfer_mono_data_3pixel(dat1<<6);//???? dat1 ?? D1\D0 ?? 2 锟斤拷????? 3 ??????(?? 7??8??9 ?????????????
	//?????????? IC ??????锟斤拷???? 3 ??????????????????? 7??8 ?????????????? 9 ???????????????? 9 ????????????? 9 ?????????0??
	//????? 9 ?????????????????????????????
}
//??? 9 ??????
void transfer_mono_data_9pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_6pixel(dat1);//????? 6 ??????
	transfer_mono_data_3pixel((dat1<<6)|(dat2>>2)); //??? dat1 ?? D1??D0 ?? dat2 ?? D7 锟斤拷????? 3 ??????(?? 7??8??9 ????????????????锟斤拷???????+1 ??
}
//??? 12 ??????
void transfer_mono_data_12pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_9pixel(dat1,dat2);//????? 9 ??????
	transfer_mono_data_3pixel(dat2<<1); //???? dat2 ?? D6\D5\D4 ?? 3 锟斤拷??????? 10??11??12 ???????????????????锟斤拷???????+1??
}
//??? 15 ??????
void transfer_mono_data_15pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_12pixel(dat1,dat2); //????? 12 ??????
	transfer_mono_data_3pixel(dat2<<4); //???? dat2 ?? D3\D2\D1 ?? 3 锟斤拷??????? 13??14??15 ?????????????????锟斤拷???????+1??
}
//??? 16 ??????
void transfer_mono_data_16pixel(u8 dat1,u8 dat2)
{
	transfer_mono_data_15pixel(dat1,dat2); //????? 15 ??????
	transfer_mono_data_3pixel(dat2<<7); //????? 16 ??????,??? dat2 ?? D0 锟斤拷??
//?????????? IC ??????锟斤拷???? 3 ??????????????????? 16 ?????????????? 17??18 ???????????????? 18 ?????? ???????17??18 ?????????0??
//????? 17??18 ?????????????????????????????
}
//??? 18 ??????
void transfer_mono_data_18pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_15pixel(dat1,dat2); //????? 15 ??????
	transfer_mono_data_3pixel((dat2<<7)|(dat3>>1)); //???? dat2 ?? D0 ?? dat3 ?? D7??D6 ?? 3 锟斤拷??????? 16??17??18 ?????????????????锟斤拷???????+1 ??
}
//??? 21 ??????
void transfer_mono_data_21pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_18pixel(dat1,dat2,dat3); //????? 18 ??????
	transfer_mono_data_3pixel(dat3<<2); //???? dat3 ?? D5??D4??D3 ?? 3 锟斤拷??????? 19??20??21 ?????????????????锟斤拷???????+1??
}
//??? 24 ????????????
void transfer_mono_data_24pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_mono_data_21pixel(dat1,dat2,dat3); //????? 21 ??????
	transfer_mono_data_3pixel(dat3<<5); //???? dat3 ?? D2??D1??D0 ?? 3 锟斤拷??????? 22??23??24 ?????????????????锟斤拷???????+1??
}
//??? 27 ??????
void transfer_mono_data_27pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_3pixel(dat4); //???? dat4 ?? D7??D6??D5 ?? 3 锟斤拷??????? 25?? 26??27 ?????????????????锟斤拷???????+1??
}
//??? 30 ??????
void transfer_mono_data_30pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_6pixel(dat4); //????? 6 ??????24+6=30
}
//??? 32 ??????
void transfer_mono_data_32pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_8pixel(dat4); //????? 8 ??????24+8=32
//?????????? IC ??????锟斤拷???? 3 ??????????????????? 31??32 ?????????????? 33 ???????????????? 33 ?????? ???????33 ?????????0??
//????? 33 ?????????????????????????????
}
//??? 33 ??????
void transfer_mono_data_33pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4,u8 dat5)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_9pixel(dat4,dat5); //????? 9 ??????
}
//??? 48 ??????
void transfer_mono_data_48pixel(u8 dat1,u8 dat2,u8 dat3,u8 dat4,u8 dat5,u8 dat6)
{
	transfer_mono_data_24pixel(dat1,dat2,dat3); //????? 24 ??????
	transfer_mono_data_24pixel(dat4,dat5,dat6); //????? 24 ??????
}	
	

//????????????? 3 ??????? 4 ??????????????? SEG0?? SEG1??SEG2,?? 3 ?????????????锟斤拷???? ??????
//????????(gray_data)???SEG0 ????? 3 锟斤拷??D7?? D6??D5??,SEG1 ????? 3 锟斤拷??D4??D3??D2),SEG2 ???????锟斤拷??D1??D0????
void transfer_gray_data_3pixel(u8 dat1)
{
	u8 gray_data;
	
	gray_data=dat1&0xc0;; //?? gray_data ?? D7??D6 ???(=dat1 ?? D7??D6)
	if((dat1&0xc0)==0xc0)
	{
		gray_data|=0x20; //?? gray_data ?? D5 ??????? dat1 ?? D7??D6 ???? 1 ?????gray_data ?? D5=1,?? dat1 ?? D7\D6 ?????? 1 ?????gray_data ?? D5=0
	}
	gray_data|=((dat1>>1)&0x18); //?? gray_data ?? D4??D3 ?????=dat1 ?? D5??D4)
	if((dat1&0x30)==0x30)
	{
		gray_data|=0x04; //?? gray_data ?? D2 ??????? dat1 ?? D5??D4 ???? 1 ?????gray_data ?? D2=1,?? dat1 ?? D7??D6 ?????? 1 ?????gray_data ?? D2=0
	}
	gray_data|=((dat1>>2)&0x03); //?? gray_data ?? D1??D0 ???(=dat1 ?? D3??D2)
	LCD_WR_DATA(gray_data); //???? 1 ??????????????????? IC,????? 3 ??????????(seg_N,seg_N+1,seg_N+2)
}


//????????????? 12 ??????? 4 ????????????? SEG0??SEG1??SEG2......SEG9??SEG10??SEG11???? 12 ???????? 4 ???锟斤拷????
//? 2 锟斤拷?????????????12 ?????????2*12=24 锟斤拷???? 3 ?????:dat1??dat2??dat3
void transfer_gray_data_12pixel(u8 dat1,u8 dat2,u8 dat3)
{
	transfer_gray_data_3pixel(dat1); //??? 3 ??????(seg_N,seg_N+1,SEG_N+2)
	transfer_gray_data_3pixel((dat1<<6)|(dat2>>2)); //??? 3 ??????(seg_N+3,seg_N+4,SEG_N+5)
	transfer_gray_data_3pixel((dat2<<4)|(dat3>>4)); //??? 3 ??????(seg_N+6,seg_N+7,SEG_N+8)
	transfer_gray_data_3pixel(dat3<<2); //??? 3 ??????(seg_N+9,seg_N+10,SEG_N+11)
}


/*????*/
void LCD_Clear(void)
{
	int i,j;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<160;i++)
	{
		for(j=0;j<20;j++)
		{
			transfer_mono_data_18pixel(0x00,0x00,0x00); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//??? 240*160 ????????
void disp_240x160(u8 *dp)
{
	u16 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	for(i=0;i<160;i++)
	{
		for(j=0;j<10;j++)//??? 10 ?锟斤拷??????? 24 ???????? 240 ??????
		{
			dat1=*dp;dp++;
			dat2=*dp;dp++;
			dat3=*dp;dp++;
			transfer_mono_data_24pixel(dat1,dat2,dat3); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//===?????????锟斤拷??????????????????????????????????=====
void test_display(u8 dat1,u8 dat2,u8 dat3)
{
	u16 i,j;
	
	lcd_address(0,0,240,160);
	LCD_WriteRAM_Prepare();
	for(i=0;i<160;i++)
	{
		for(j=0;j<10;j++)//??? 10 ?锟斤拷??????? 24 ???????? 240 ??????
		{
			transfer_mono_data_24pixel(dat1,dat2,dat3); //????????? 8 ????????? 8*3=24 ??????
		}
	}
}


//??? 240*160 ????? 4 ???????
void disp_4gray_240x160(u8 *dp)
{
	u8 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(0,0,240,160); //
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<160;i++)
	{
		for(j=0;j<20;j++)//??? 20 ?锟斤拷??????? 12 ???????? 20*12=240 ??????
		{
			dat1=*dp;dp++;
			dat2=*dp;dp++;
			dat3=*dp;dp++;
			transfer_gray_data_12pixel(dat1,dat2,dat3); //????????? 4 ?????????? 4*3=12 ??????
		}
	}
}



/**
 * @brief  ?????锟斤拷????????8x16?????
 * @param  x: ?????? 0-239
 * @param  y: ?????? 0-159
 * @param  num: ?????????ASCII??
 */
void LCD_ShowChar(u16 x, u16 y, u8 num)
{
    u8 temp, i;
    const u8 *font_ptr = NULL; // ?????????????????

    // ?锟斤拷????????????????????????
    if (num >= '0' && num <= '9')
    {
        // ?????????
        font_ptr = &asc2_1608_number[num - '0'][0];
    }
		else if (num == '.' )
    {
        // ??????锟斤拷???
        font_ptr = &asc2_1608_number[10][0];
    }
    
    else if (num >= 'A' && num <= 'Z')
    {
        // ??????锟斤拷???
        font_ptr = &asc2_1608_UppL[num - 'A'][0];
    }
    // else if (num >= 'a' && num <= 'z')
    // {
    //     // ??????????????锟斤拷锟斤拷?????????????????????
    //     font_ptr = &asc2_1608_LowL[num - 'a'][0];
    // }
	else if (num == ' ')
    {
        // ????????????????????????
        // ????????????? 8x16 ????????
        lcd_address(x, y, 8, 16);
        LCD_WriteRAM_Prepare();
        for (i = 0; i < 16; i++)
        {
            transfer_mono_data_8pixel(0x00); // ?????0????????????
        }
        return; // ???????????????
    }
    else
    {
        // ????????????????????????????????????????????
        // ?????????????????????锟斤拷????????????????????????
        return; // ????????????锟斤拷???????
    }

    // ???????????????
    if (font_ptr)
    {
        lcd_address(x, y, 8, 16); // ???????????? 8x16
        LCD_WriteRAM_Prepare();   // ???锟斤拷GRAM

        for (i = 0; i < 16; i++) // ???16?锟斤拷???????8x16?????
        {
            temp = font_ptr[i]; // ????????8???????????
            transfer_mono_data_8pixel(temp); // ????????????????????????????8????????????????
        }
    }
}


/**
 * @brief  锟斤拷指锟斤拷位锟斤拷锟斤拷示一锟斤拷8x16锟斤拷锟街凤拷
 * @param  x: 锟斤拷锟斤拷锟斤拷 0-239
 * @param  y: 锟斤拷锟斤拷锟斤拷 0-159
 * @param  num: 要锟斤拷示锟斤拷锟街凤拷ASCII锟斤拷
 */
void LCD_ShowChar_Large(u16 x, u16 y, u8 num)//这个函数没有写好,显示不了字母
{
    u8 temp, i;
    const u8 *font_ptr = NULL; // 锟饺达拷锟斤拷一锟斤拷锟秸碉拷锟街匡拷指锟斤拷

    // 锟叫讹拷锟街凤拷锟斤拷锟酵ｏ拷锟斤拷锟斤拷取锟斤拷确锟斤拷锟街匡拷锟斤拷?
    if (num >= '0' && num <= '9')
    {
        // 锟斤拷锟斤拷锟斤拷锟斤拷锟??
        font_ptr = &asc2_1608_number_Large[num - '0'][0];
    }
		else if (num == '.' )
    {
        // ??????锟斤拷???
        font_ptr = &asc2_1608_number_Large[10][0];
    }
    else if (num >= 'A' && num <= 'Z')
    {
        // 锟斤拷锟斤拷谴锟叫达拷锟斤拷?
        font_ptr = &asc2_1608_UppL[num - 'A'][0];
    }
    // else if (num >= 'a' && num <= 'z')
    // {
    //     // 锟斤拷锟斤拷院锟斤拷锟斤拷锟斤拷锟斤拷锟叫⌒达拷锟侥革拷挚锟??锟斤拷锟斤拷取锟斤拷锟斤拷锟斤拷锟斤拷?锟斤拷
    //     font_ptr = &asc2_1608_LowL[num - 'a'][0];
    // }
	else if (num == ' ')
    {
        // 锟斤拷锟斤拷强崭锟斤拷锟斤拷獯︼拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷挚锟??
        // 直锟斤拷准锟斤拷锟斤拷锟斤拷一锟斤拷 8x16 锟侥空帮拷锟斤拷锟斤拷
        lcd_address(x, y, 30, 77);
        LCD_WriteRAM_Prepare();
        for (i = 0; i < 77; i++)
        {
            transfer_mono_data_16pixel(0x00,0x00); // 锟斤拷锟斤拷全0锟斤拷锟捷ｏ拷锟斤拷锟斤拷锟斤拷色
        }
        return; // 锟秸革拷锟斤拷锟斤拷希锟街憋拷臃锟斤拷锟??
    }
    else
    {
        // 锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷锟街凤拷锟斤拷锟斤拷锟斤拷崭瘛⒈锟斤拷锟斤拷诺龋锟斤拷锟斤拷锟斤拷锟斤拷锟绞憋拷锟斤拷锟斤拷?
        // 锟斤拷也锟斤拷锟斤拷锟斤拷锟斤拷锟斤拷指锟斤拷一锟斤拷锟斤拷未知锟街凤拷锟斤拷锟斤拷锟斤拷模锟斤拷锟斤拷锟斤拷一锟斤拷锟斤拷锟斤拷
        return; // 直锟接凤拷锟截ｏ拷锟斤拷锟斤拷锟叫猴拷锟斤拷锟斤拷锟斤拷
    }

    // 锟斤拷锟斤拷业锟斤拷撕戏锟斤拷锟斤拷挚锟??
    if (font_ptr)
    {
        lcd_address(x, y, 30, 60); // 锟斤拷锟斤拷锟斤拷示锟斤拷锟斤拷为 8x16
        LCD_WriteRAM_Prepare();   // 准锟斤拷写GRAM

        for (i = 0; i < 60; i++) // 循锟斤拷16锟叫ｏ拷锟斤拷示一锟斤拷8x16锟斤拷锟街凤拷
        {
            //temp = font_ptr[i]; // 取锟斤拷锟斤拷前锟斤拷8锟斤拷锟斤拷锟截碉拷锟斤拷锟斤拷
            //transfer_mono_data_8pixel(temp); // 锟斤拷锟斤拷锟斤拷锟斤拷锟窖撅拷锟斤拷锟斤拷锟斤拷锟侥猴拷锟斤拷锟斤拷锟斤拷锟斤拷8锟斤拷锟斤拷锟截碉拷锟斤拷锟捷凤拷锟酵筹拷去
			u8 dat1 = font_ptr[i * 4];     // 
        	u8 dat2 = font_ptr[i * 4 + 1]; // 
			u8 dat3 = font_ptr[i * 4 + 2]; // 
			u8 dat4 = font_ptr[i * 4 + 3];     // 
        	transfer_mono_data_30pixel(dat1, dat2, dat3, dat4);
		}
    }
}

/**
 * @brief  在指定位置显示一个字符串（普通字体8x16）
 * @param  x: 起始坐标 0-239
 * @param  y: 起始坐标 0-159
 * @param  str: 要显示的字符串
 */
void LCD_ShowString(u16 x, u16 y, const char* str)
{
    u16 current_x = x;
    u16 i = 0;
    
    while (str[i] != '\0' && current_x < 240 - LCD_Show_Xpos) // 防止超出屏幕边界
    {
        LCD_ShowChar(current_x, y, str[i]);
        current_x += LCD_Show_Xpos; // 移动到下一个字符位置（字符宽度为3像素）
        i++;
    }
}

/**
 * @brief  在指定位置显示一个字符串（大字体）
 * @param  x: 起始坐标 0-239
 * @param  y: 起始坐标 0-159
 * @param  str: 要显示的字符串
 */
void LCD_ShowString_Large(u16 x, u16 y, const char* str)
{
    u16 current_x = x;
    u16 i = 0;
    
    while (str[i] != '\0' && current_x < 240 - LCD_Show_Large_Xpos) // 防止超出屏幕边界
    {
        LCD_ShowChar_Large(current_x, y, str[i]);
        current_x += LCD_Show_Large_Xpos; // 移动到下一个字符位置（大字体宽度为9像素）
        i++;
    }
}


void LCD_ShowFloat_70(u16 x, u16 y, float value)
{
    char buf[6]; // 鏈€澶?"70.0\0"
    int len;
    sprintf(buf, "%4.1f", value); // 鍙冲?归綈锛屽?藉害4锛?1浣嶅皬鏁?
    len = strlen(buf);

    // 鎿﹂櫎鏄剧ず鍖哄煙
    for (int i = 0; i < 4; i++)
        LCD_ShowChar(x + i * LCD_Show_Xpos, y, ' ');

    // 鍙冲?归綈鏄剧ず
    for (int i = 0; i < len; i++)
        LCD_ShowChar(x + (i + (4 - len)) * LCD_Show_Xpos, y, buf[i]);
}

// 澶у瓧鍙凤紝瀛楃?﹀?藉害gap
void LCD_ShowFloat_70_Large(u16 x, u16 y, float value)
{
    char buf[6];
    int len = 32;
    sprintf(buf, "%4.1f", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar_Large(x + i * LCD_Show_Large_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar_Large(x + (i + (4 - len)) * LCD_Show_Large_Xpos, y, buf[i]);
}

// 鏅?閫氬瓧鍙锋暣鏁帮紝鏈€澶?4浣嶏紝瀛楃?﹀?藉害8
void LCD_ShowInt_3000(u16 x, u16 y, int value)
{
    char buf[5];
    int len;
    sprintf(buf, "%4d", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar(x + i * LCD_Show_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar(x + (i + (4 - len)) * LCD_Show_Xpos, y, buf[i]);
}

// 澶у瓧鍙锋暣鏁帮紝鏈€澶?4浣嶏紝瀛楃?﹀?藉害gap
void LCD_ShowInt_3000_Large(u16 x, u16 y, int value)
{
    char buf[5];
    int len = 32;
    sprintf(buf, "%4d", value);
    len = strlen(buf);

    for (int i = 0; i < 4; i++)
        LCD_ShowChar_Large(x + i * LCD_Show_Large_Xpos, y, ' ');

    for (int i = 0; i < len; i++)
        LCD_ShowChar_Large(x + (i + (4 - len)) * LCD_Show_Large_Xpos, y, buf[i]);
}


// 閫氱敤娴?鐐规暟閽充綅鍑芥暟
float clamp_float(float value, float min, float max)
{
	if (value < min) return min;
	if (value > max) return max;
	return value;
}

int8_t clamp_int8(int8_t value, int8_t min, int8_t max)
{
    if (value < min) return min;
    if (value > max) return max;
    return value;
}

int16_t clamp_int16(int16_t value, int16_t min, int16_t max)
{
    if (value < min) return min;
    if (value > max) return max;
    return value;
}
/*-------------------------------------Graphic Drawing------------------------------------------------------------------*/

// 低资源单点画点/清点函数
void LCD_Update3Pixel(uint16_t x, uint16_t y, uint8_t set)
{
    uint8_t group = x / 3;      // 3像素一组
    uint8_t bit = x % 3;        // 组内第几个像素
    uint8_t data = 0x00;

    // 只设置目标像素
    data = (1 << (7 - bit * 3)); // D7/D4/D1分别对应bit=0/1/2

    lcd_address(group, y, 1, 1);
    LCD_WriteRAM_Prepare();
    if (set)
        transfer_mono_data_3pixel(data); // 画点
    else
        transfer_mono_data_3pixel(0x00); // 清点（只清本组所有点，无法单独清一个点，硬件限制）
}

// 画单点（只显示目标点，其他点清空）
void LCD_DrawPoint(uint16_t x, uint16_t y)
{
    uint8_t group = x / 3;
    uint8_t bit = x % 3;
    static uint8_t line_buf[80];
    for (int i = 0; i < 80; i++) line_buf[i] = 0x00; // 清空整行
    // 设置目标点
    line_buf[group] = (1 << (7 - bit * 3));
    lcd_address(0, y, 240, 1);
    LCD_WriteRAM_Prepare();
    for (int i = 0; i < 80; i++)
        transfer_mono_data_3pixel(line_buf[i]);
}

void LCD_DrawLine_Mode(uint8_t x, uint8_t y,uint8_t x_total,uint8_t y_total)
{
		u8 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(x,y,x_total,x_total); //
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<y_total;i++)
	{
		for(j=0;j<x_total/3;j++)//??? 20 ?锟斤拷??????? 12 ???????? 20*12=240 ??????
		{
			transfer_gray_data_3pixel(0xFF); //????????? 4 ?????????? 4*3=12 ??????
		}
	}
}

void LCD_ClearLine_Mode(uint8_t x, uint8_t y,uint8_t x_total,uint8_t y_total)
{
		u8 i,j;
	u8 dat1,dat2,dat3;
	
	lcd_address(x,y,x_total,x_total); //
	LCD_WriteRAM_Prepare();
	
	for(i=0;i<y_total;i++)
	{
		for(j=0;j<x_total/3;j++)//??? 20 ?锟斤拷??????? 12 ???????? 20*12=240 ??????
		{
			transfer_gray_data_3pixel(0x00); //????????? 4 ?????????? 4*3=12 ??????
		}
	}
}


// 清除单点（整行清空）
void LCD_ClearPoint(uint16_t x, uint16_t y)
{
    lcd_address(0, y, 240, 1);
    LCD_WriteRAM_Prepare();
    for (int i = 0; i < 80; i++)
        transfer_mono_data_3pixel(0x00);
}

// // 画点函数（如已有可直接用）
// void LCD_DrawPoint(uint16_t x, uint16_t y)
// {
//     lcd_address(x, y, 1, 1);
//     LCD_WriteRAM_Prepare();
//     transfer_mono_data_9pixel(0xFF); // 显示一个点
// }

// // 清除一个像素点（显示为黑色/背景色）
// void LCD_ClearPoint(uint16_t x, uint16_t y)
// {
//     lcd_address(x+1, y, 1, 1);
//     LCD_WriteRAM_Prepare();
//     transfer_mono_data_8pixel(0x00); // 清除一个点
// }

// 直线绘制（Bresenham算法）
void LCD_DrawLine(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1)
{
    int dx = abs(x1 - x0), dy = abs(y1 - y0);
    int sx = x0 < x1 ? 1 : -1;
    int sy = y0 < y1 ? 1 : -1;
    int err = (dx > dy ? dx : -dy) / 2, e2;

    while (1) {
        LCD_DrawPoint(x0, y0);
        if (x0 == x1 && y0 == y1) break;
        e2 = err;
        if (e2 > -dx) { err -= dy; x0 += sx; }
        if (e2 < dy) { err += dx; y0 += sy; }
    }
}

// 只画圆的1/4（象限1~4），用于圆角
void LCD_DrawCirclePart(uint16_t xc, uint16_t yc, uint16_t r, uint8_t quadrant)
{
    int x = 0, y = r;
    int d = 3 - 2 * r;
    while (x <= y) {
        switch (quadrant) {
            case 1: // 左上
                LCD_DrawPoint(xc - x, yc - y);
                LCD_DrawPoint(xc - y, yc - x);
                break;
            case 2: // 右上
                LCD_DrawPoint(xc + x, yc - y);
                LCD_DrawPoint(xc + y, yc - x);
                break;
            case 3: // 左下
                LCD_DrawPoint(xc - y, yc + x);
                LCD_DrawPoint(xc - x, yc + y);
                break;
            case 4: // 右下
                LCD_DrawPoint(xc + x, yc + y);
                LCD_DrawPoint(xc + y, yc + x);
                break;
        }
        if (d < 0) d += 4 * x + 6;
        else { d += 4 * (x - y) + 10; y--; }
        x++;
    }
}

// 绘制圆角矩形
void LCD_DrawRoundRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint8_t radius, uint8_t lineWidth)
{
    // 画四条边（去掉圆角部分）
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        // 上边
        LCD_DrawLine(x + radius + lw, y + lw, x + width - radius - lw - 1, y + lw);
        // 下边
        LCD_DrawLine(x + radius + lw, y + height - lw - 1, x + width - radius - lw - 1, y + height - lw - 1);
        // 左边
        LCD_DrawLine(x + lw, y + radius + lw, x + lw, y + height - radius - lw - 1);
        // 右边
        LCD_DrawLine(x + width - lw - 1, y + radius + lw, x + width - lw - 1, y + height - radius - lw - 1);
    }
    // 画四个圆角
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        LCD_DrawCirclePart(x + radius, y + radius, radius - lw, 1); // 左上
        LCD_DrawCirclePart(x + width - radius - 1, y + radius, radius - lw, 2); // 右上
        LCD_DrawCirclePart(x + radius, y + height - radius - 1, radius - lw, 3); // 左下
        LCD_DrawCirclePart(x + width - radius - 1, y + height - radius - 1, radius - lw, 4); // 右下
    }
}

// 绘制普通矩形
void LCD_DrawRect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint8_t lineWidth)
{
    for (uint8_t lw = 0; lw < lineWidth; lw++) {
        // 上边
        LCD_DrawLine(x + lw, y + lw, x + width - lw - 1, y + lw);
        // 下边
        LCD_DrawLine(x + lw, y + height - lw - 1, x + width - lw - 1, y + height - lw - 1);
        // 左边
        LCD_DrawLine(x + lw, y + lw, x + lw, y + height - lw - 1);
        // 右边
        LCD_DrawLine(x + width - lw - 1, y + lw, x + width - lw - 1, y + height - lw - 1);
    }
}